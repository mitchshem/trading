# Paper Broker Bug Fixes Summary

## Overview

This document describes the four critical bug fixes applied to `paper_broker.py` to ensure mathematically valid accounting and safe risk enforcement.

## Fix 1: Cash-Based Equity Accounting

### Problem
The original implementation calculated equity as `initial_equity + realized_pnl + unrealized_pnl`, which doesn't properly track cash flow from trades.

### Solution
- **Introduced `self.cash`**: Tracks available cash separately from equity
- **On initialization**: `self.cash = initial_equity` and `self.equity = initial_equity`
- **On BUY**: Deduct `shares * fill_price` from `self.cash`
- **On EXIT**: Add `shares * fill_price` to `self.cash`
- **Equity calculation**: `equity = cash + sum(unrealized_pnl of open positions)`

### Implementation Details
- In `__init__`: Added `self.cash = initial_equity`
- In `execute_buy()`: Deduct cost from cash before creating position
- In `execute_exit()`: Add proceeds to cash after closing position
- In `update_equity()`: Changed from `initial_equity + realized_pnl + unrealized_pnl` to `cash + unrealized_pnl`

### Why This Matters
Cash-based accounting ensures:
- Equity accurately reflects available capital
- Positions are funded from actual cash reserves
- Insufficient cash prevents new positions
- Equity = cash + unrealized gains/losses (standard accounting)

## Fix 2: Automatic Stop-Loss Enforcement

### Problem
Stop-losses were only checked when EXIT signals were generated by the strategy, not automatically on every candle close.

### Solution
- **New method `check_stop_losses()`**: Checks all open positions on candle close
- **Automatic enforcement**: If `current_price <= stop_price`, force EXIT with reason "STOP_LOSS"
- **Called on every candle close**: Before processing strategy signals

### Implementation Details
- Added `check_stop_losses(current_prices, timestamp)` method
- Checks all positions: `if current_price <= position.stop_price`
- Calls `execute_exit()` with reason "STOP_LOSS"
- Integrated into `evaluate_strategy_on_candle_close()` in `main.py`

### Why This Matters
- Protects capital from adverse moves between signals
- Ensures stop-losses are enforced deterministically
- Prevents positions from exceeding risk tolerance
- Critical for risk management in automated trading

## Fix 3: Max Open Positions Limit

### Problem
No limit on the number of concurrent open positions, which could lead to over-concentration of risk.

### Solution
- **Hard limit**: Maximum 3 open positions
- **Enforcement**: Check `len(self.positions) >= 3` in `execute_buy()`
- **Block trade**: Return `None` if limit reached

### Implementation Details
- Added check in `execute_buy()`: `if len(self.positions) >= 3: return None`
- Placed after kill switch check but before position size calculation

### Why This Matters
- Prevents over-concentration of risk
- Ensures diversification across symbols
- Limits maximum exposure at any time
- Standard risk management practice

## Fix 4: Kill Switch Behavior (Fail-Safe)

### Problem
Kill switch relied on external callers to close positions, creating a potential failure point if the caller doesn't properly handle the kill switch.

### Solution
- **New method `check_and_enforce_risk_controls()`**: Self-contained risk checking
- **Automatic position closure**: When daily loss limit breached, immediately close ALL positions
- **Fail-safe design**: No reliance on external code to flatten positions
- **Called on every candle close**: Ensures continuous monitoring

### Implementation Details
- Added `check_and_enforce_risk_controls(current_prices, timestamp)` method
- Checks daily loss limit: `if check_daily_loss_limit() and not trade_blocked`
- Automatically calls `trigger_kill_switch()` and `close_all_positions()`
- Integrated into `evaluate_strategy_on_candle_close()` in `main.py`

### Why This Matters
- Fail-safe design: Risk controls cannot be bypassed
- Automatic protection: No manual intervention required
- Immediate response: All positions closed as soon as limit breached
- Prevents catastrophic losses from continuing

## How Equity, Stop-Losses, and Kill Switch Now Work

### Equity Calculation
```
1. Start with cash = initial_equity
2. On BUY: cash -= (shares * fill_price)
3. On EXIT: cash += (shares * fill_price)
4. Equity = cash + sum(unrealized_pnl for all open positions)
```

**Example:**
- Initial: cash = $100,000, equity = $100,000
- BUY 100 shares @ $50: cash = $95,000, equity = $95,000 (no unrealized yet)
- Price moves to $52: cash = $95,000, equity = $95,000 + ($52 - $50) * 100 = $97,000
- EXIT @ $52: cash = $97,000, equity = $97,000 (no positions)

### Stop-Loss Enforcement
```
1. On every candle close:
   - For each open position:
     - Get current price (candle close)
     - If current_price <= stop_price:
       - Execute EXIT immediately
       - Reason: "STOP_LOSS"
       - Update cash and realized P&L
```

**Example:**
- Position: 100 shares @ $50, stop_price = $48
- Candle closes at $47.50
- Stop-loss triggered: EXIT @ $47.50
- P&L: ($47.50 - $50) * 100 = -$250

### Kill Switch Behavior
```
1. On every candle close:
   - Update equity with current prices
   - Calculate daily_pnl = realized_pnl + unrealized_pnl
   - If daily_pnl <= -2% of equity:
     - Set trade_blocked = True
     - Close ALL open positions immediately
     - Block all new trades for the day
```

**Example:**
- Equity: $100,000
- Max daily loss: $2,000 (2%)
- Daily P&L reaches -$2,100
- Kill switch triggers:
  - All positions closed at current prices
  - trade_blocked = True
  - No new trades allowed until next day

## Testing Recommendations

1. **Cash Accounting**: Verify cash decreases on BUY and increases on EXIT
2. **Equity Accuracy**: Verify equity = cash + unrealized_pnl at all times
3. **Stop-Loss**: Verify positions close when price hits stop
4. **Position Limit**: Verify 4th BUY signal is blocked when 3 positions open
5. **Kill Switch**: Verify all positions close when daily loss limit breached

## Files Modified

- `backend/paper_broker.py`: All four fixes implemented
- `backend/main.py`: Integration of stop-loss and kill switch checks

## Inline Comments

All fixes are marked with inline comments:
- `# FIX 1: CASH-BASED EQUITY ACCOUNTING`
- `# FIX 2: AUTOMATIC STOP-LOSS ENFORCEMENT`
- `# FIX 3: MAX OPEN POSITIONS LIMIT`
- `# FIX 4: KILL SWITCH BEHAVIOR (FAIL-SAFE)`
